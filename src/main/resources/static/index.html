<!DOCTYPE html>
<html lang="uz">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WebSocket O'yin Paneli</title>
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<style>
		/* Telegram dizayn o'zgaruvchilari (variables) */
         :root {
             --tg-bg-color: var(--tg-theme-bg-color, #f9fafb);
             --tg-text-color: var(--tg-theme-text-color, #222);
             --tg-hint-color: var(--tg-theme-hint-color, #999);
             --tg-button-color: var(--tg-theme-button-color, #007BFF);
             --tg-button-text-color: var(--tg-theme-button-text-color, #ffffff);
             --tg-secondary-bg-color: var(--tg-theme-secondary-bg-color, #ffffff);
             --tg-border-color: #e0e0e0;
         }

         body {
             font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
             padding: 15px;
             background-color: var(--tg-bg-color);
             color: var(--tg-text-color);
             margin: 0;
         }

         .container {
             display: flex;
             flex-direction: column;
             gap: 20px;
         }

         h2, h3 {
             color: var(--tg-text-color);
             margin-top: 0;
             border-bottom: 1px solid var(--tg-border-color);
             padding-bottom: 10px;
         }

         .card {
             background: var(--tg-secondary-bg-color);
             padding: 15px;
             border-radius: 12px;
             box-shadow: 0 4px 12px rgba(0,0,0,0.05);
         }

         input, select, button {
             width: 100%;
             padding: 12px;
             margin: 8px 0;
             border-radius: 8px;
             border: 1px solid var(--tg-border-color);
             background: var(--tg-bg-color);
             color: var(--tg-text-color);
             box-sizing: border-box; /* To'g'ri o'lcham uchun */
             font-size: 16px;
         }

         input:focus, select:focus {
             outline: none;
             border-color: var(--tg-button-color);
         }

         button {
             background: var(--tg-button-color);
             color: var(--tg-button-text-color);
             border: none;
             cursor: pointer;
             font-weight: bold;
             transition: opacity 0.2s ease;
         }

         button:hover {
             opacity: 0.85;
         }

         button:disabled {
             background-color: var(--tg-hint-color);
             cursor: not-allowed;
         }

         pre {
             background: var(--tg-bg-color);
             padding: 12px;
             border-radius: 8px;
             border: 1px solid var(--tg-border-color);
             overflow-x: auto;
             max-height: 250px;
             font-size: 14px;
             word-wrap: break-word;
             white-space: pre-wrap;
         }

         .status-badge {
             display: inline-block;
             padding: 4px 10px;
             border-radius: 15px;
             color: white;
             font-size: 12px;
             font-weight: 500;
         }
         /* Player Statuslar */
         .status-WAITING { background: #f39c12; }
         .status-READY { background: #2ecc71; }
         .status-PLAYING { background: #3498db; }
         .status-IN_GAME { background: #1abc9c; }
         .status-LOSE { background: #e74c3c; }
         .status-WIN { background: #008000; }


         #statusMessage {
             text-align: center;
             padding: 15px;
             border-radius: 8px;
             margin-bottom: 15px;
             display: none; /* Boshida ko'rinmas */
         }
         .status-error {
             background-color: #ffebee;
             color: #c62828;
         }
         .status-loading {
             background-color: #e3f2fd;
             color: #1565c0;
         }
         .websocket-status {
             text-align: center;
             padding: 10px;
             border-radius: 8px;
             font-weight: bold;
             margin-bottom: 10px;
             font-size: 14px;
         }
         .websocket-connected {
             background-color: #e6ffe6;
             color: #008000;
         }
         .websocket-disconnected {
             background-color: #ffcccc;
             color: #cc0000;
         }

         #logList {
             max-height: 200px;
             overflow-y: scroll;
             font-size: 12px;
             color: var(--tg-text-color);
         }
         .log-error {
             color: #c62828; /* Qizil rang */
             font-weight: bold;
         }

	</style>
</head>
<body>

<div class="container">
	<h2>🎮 O'yin Paneli</h2>

	<div id="statusMessage"></div>

	<div class="card" id="playerCard" style="display:none;">
		<h3>Sizning ma'lumotingiz</h3>
		<div id="websocketStatus" class="websocket-status websocket-disconnected">WebSocket: Uzilgan</div>
		<div id="playerInfo"></div>
	</div>

	<div class="card" id="editSection" style="display:none;">
		<h3>O'yinni Boshqarish</h3>
		<label for="playerState">Holatni o'zgartirish:</label>
		<select id="playerState">
			<option value="WAITING">WAITING</option>
			<option value="READY">READY</option>
			<option value="PLAYING">PLAYING</option>
			<option value="IN_GAME">IN_GAME</option>
			<option value="LOSE">LOSE</option>
			<option value="WIN">WIN</option>
		</select>

		<label for="choosePlayerId">O'yinchi ID'sini tanlash (ixtiyoriy):</label>
		<input type="text" id="choosePlayerId" placeholder="Masalan: 12345678" />

		<button id="updateButton" onclick="sendUpdate()">✅ Serverga yuborish</button>
	</div>

	<div class="card" id="groupSection" style="display:none;">
		<h3>Guruh holati (real vaqtda)</h3>
		<pre id="groupData">Ulanish kutilmoqda...</pre>
	</div>

	<div class="card" id="logSection">
		<h3>Loglar va Xatolar</h3>
		<pre id="logList">--- Loglar ---</pre>
	</div>
</div>

<script>
	// --- KONFIGURATSIYA ---
    const BACKEND_URL = 'https://6f48c76447e9.ngrok-free.app';
    // -----------------------

    let stompClient = null;
    let currentGroupId = null;
    let currentChatId = null;
    const tg = window.Telegram.WebApp;

    // Elementlarni o'zgaruvchiga olish
    const statusMessageEl = document.getElementById("statusMessage");
    const playerCardEl = document.getElementById("playerCard");
    const editSectionEl = document.getElementById("editSection");
    const groupSectionEl = document.getElementById("groupSection");
    const updateButton = document.getElementById("updateButton");
    const websocketStatusEl = document.getElementById("websocketStatus");
    const logListEl = document.getElementById("logList"); // Yangi log elementi

    // Konsol loglari o'rniga ishlatiladigan funksiya
    function customLog(message, type = 'log') {
        const timestamp = new Date().toLocaleTimeString();
        let logMessage = `[${timestamp}] ${message}`;

        // 1. Konsolga yozish (agar mavjud bo'lsa)
        if (type === 'error') {
            console.error(logMessage);
            logMessage = `<span class="log-error">${logMessage}</span>`;
        } else {
            console.log(logMessage);
        }

        // 2. Ekranga yozish
        logListEl.innerHTML += logMessage + '\n';
        // Skrollni pastga tushirish
        logListEl.scrollTop = logListEl.scrollHeight;
    }

    // Sahifa yuklanganda ishga tushadigan funksiya
    document.addEventListener('DOMContentLoaded', () => {
        tg.ready();
        tg.expand();
        customLog("Telegram Web App tayyorlandi.");

        const user = tg.initDataUnsafe?.user;

        if (user?.id) {
            currentChatId = user.id;
            customLog(`Foydalanuvchi ID: ${currentChatId}`);
            loadPlayer(currentChatId);
        } else {
            showStatus("Xatolik: Ilovani Telegram orqali oching.", 'error');
            customLog("Telegram user data topilmadi.", 'error');
        }
    });

    function showStatus(message, type = 'loading') {
        statusMessageEl.textContent = message;
        statusMessageEl.className = `status-${type}`;
        statusMessageEl.style.display = 'block';
    }

    function hideStatus() {
        statusMessageEl.style.display = 'none';
    }

    function updateWebsocketStatus(isConnected) {
        if (isConnected) {
            websocketStatusEl.textContent = "WebSocket: Ulangan ✅";
            websocketStatusEl.className = "websocket-status websocket-connected";
            if(currentGroupId) {
               updateButton.disabled = false;
            }
            customLog("WebSocket ulanishi muvaffaqiyatli!");
        } else {
            websocketStatusEl.textContent = "WebSocket: Uzilgan ❌";
            websocketStatusEl.className = "websocket-status websocket-disconnected";
            updateButton.disabled = true;
            customLog("WebSocket aloqasi uzildi.", 'error');
        }
    }

    function connectSocket(groupId) {
        if (stompClient && stompClient.connected) {
            customLog("WebSocket allaqachon ulangan. Qayta ulanish shart emas.");
            return;
        }

        customLog(`Guruh ID (${groupId}) uchun WebSocket ulanishga urinilmoqda...`);

        updateWebsocketStatus(false);
        document.getElementById("groupData").textContent = "WebSocket orqali guruh ma'lumotlariga ulanishga urinilmoqda...";

        const socket = new SockJS(`${BACKEND_URL}/ws`);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({},
            () => { // Muvaffaqiyatli ulansa
                updateWebsocketStatus(true);

                stompClient.subscribe(`/topic/room/${groupId}`, (message) => {
                    try {
                        const data = JSON.parse(message.body);
                        document.getElementById("groupData").textContent = JSON.stringify(data, null, 2);
                        customLog("Guruh ma'lumoti qabul qilindi.");
                    } catch (e) {
                        customLog(`WebSocket xabarini o'qishda xatolik: ${e}`, 'error');
                        document.getElementById("groupData").textContent = "Xato: Ma'lumot formati noto'g'ri.";
                    }
                });
                customLog(`'/topic/room/${groupId}' mavzusiga obuna bo'lindi.`);
            },
            (error) => { // Ulanishda xatolik bo'lsa
                customLog(`WebSocket ulanishda xatolik: ${error}`, 'error');
                updateWebsocketStatus(false);
                document.getElementById("groupData").textContent = "Serverga ulanib bo'lmadi. Internet aloqasini tekshiring yoki keyinroq urunib ko'ring.";
                tg.showAlert("Server bilan aloqa uzildi. Iltimos, sahifani yangilang.");
            }
        );
        // SockJS ulanish uzilganda (kutilmaganda)
        socket.onclose = () => {
             customLog('WebSocket aloqasi kutilmaganda uzildi.');
             updateWebsocketStatus(false);
        };
    }

    async function loadPlayer(chatId) {
        showStatus("O'yinchi ma'lumotlari yuklanmoqda...");
        customLog(`API orqali o'yinchi ma'lumotlarini yuklash: ${BACKEND_URL}/player/${chatId}`);
        try {
            const response = await fetch(`${BACKEND_URL}/player/${chatId}`);
            if (!response.ok) {
                // Agar status 4xx yoki 5xx bo'lsa
                throw new Error(`Server xatosi: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            hideStatus();

            currentGroupId = data.groupId;

            playerCardEl.style.display = 'block';
            document.getElementById("playerInfo").innerHTML = `
                <strong>Chat ID:</strong> ${data.chatId}<br/>
                <strong>Group ID:</strong> ${data.groupId ?? 'Guruhga qo‘shilmagan'}<br/>
                <strong>Holati:</strong> <span class="status-badge status-${data.playerState}">${data.playerState}</span>
            `;

            editSectionEl.style.display = 'block';
            document.getElementById("playerState").value = data.playerState;
            customLog(`O'yinchi ma'lumotlari yuklandi. Guruh ID: ${currentGroupId}`);

            if (currentGroupId) {
                groupSectionEl.style.display = 'block';
                // Websocket ulanishni urinish
                connectSocket(currentGroupId);
            } else {
                updateButton.disabled = true;
                updateButton.textContent = "Guruhga qo'shilmagansiz";
                websocketStatusEl.style.display = 'none';
                customLog("O'yinchi hech qaysi guruhga qo'shilmagan. WebSocket ulanishi o'tkazib yuborildi.");
            }

        } catch (error) {
            customLog(`O'yinchi ma'lumotlarini yuklashda xatolik: ${error.message}`, 'error');
            showStatus("Ma'lumotlarni yuklab bo'lmadi. Server bilan aloqani tekshiring.", 'error');
        }
    }

    function sendUpdate() {
        if (!stompClient || stompClient.connected !== true) {
            tg.HapticFeedback.notificationOccurred('error');
            tg.showAlert("❌ Server bilan aloqa yo'q (WebSocket uzilgan). Iltimos, qayta ulanishni kuting.");
            customLog("Ma'lumot yuborish rad etildi: WebSocket uzilgan.", 'error');
            return;
        }

        const playerState = document.getElementById("playerState").value;
        const choosePlayerIdInput = document.getElementById("choosePlayerId").value;

        const payload = {
            chatId: currentChatId,
            playerState: playerState,
            choosePlayerId: choosePlayerIdInput ? parseInt(choosePlayerIdInput) : null,
            groupId: currentGroupId,
            groupState: null
        };

        customLog(`Serverga yuborilmoqda: ${JSON.stringify(payload)}`);

        try {
            stompClient.send("/app/game.send", {}, JSON.stringify(payload));

            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert("✅ Ma'lumot muvaffaqiyatli yuborildi!");
            customLog("Ma'lumot muvaffaqiyatli yuborildi.");
        } catch(e) {
            customLog(`STOMP xabarini yuborishda xatolik: ${e}`, 'error');
            tg.HapticFeedback.notificationOccurred('error');
            tg.showAlert("❌ Ma'lumotni yuborishda xatolik yuz berdi.");
        }
    }
</script>

</body>
</html>